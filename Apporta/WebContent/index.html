<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<meta charset="UTF-8" />
		<title>Apporta</title>
		<style type="text/css">
			html { height: 100% }
			body { height: 100%; margin: 0; padding: 0 }
			#map_canvas { height: 100% }
		</style>
		
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyD-J2vNmhqJRrtq2snuPNW4xPpk8D6w4es&libraries=geometry,places&sensor=true&language=es&region=MX"></script>
		
		<script type="text/javascript">
			var initialLat = 25.6667;
			var initialLng = -100.3000;
			var initialZoom = 13;
			var map;
			
			var earthRadius = 6378137;
			
			var userLat;
			var userLng;
			
			var infowindow;
			var directionsDisplay;
			
			var eventsContainer;
		
			function initialize() {
				map = new google.maps.Map(document.getElementById("map_canvas"), {
					center: new google.maps.LatLng(initialLat, initialLng),
					zoom: initialZoom,
					mapTypeId: google.maps.MapTypeId.ROADMAP,
					panControl: false,
					zoomControl: true,
					mapTypeControl: false,
					streetViewControl: false,
					overviewMapControl: false
				});
				
				infowindow = new google.maps.InfoWindow();
				directionsDisplay = new google.maps.DirectionsRenderer();
				
				userLat = 25.6498049;
				userLng = -100.2911006;
				
				var marker = createMarker(userLat, userLng, "Usuario");
				marker.setMap(map);
				
				google.maps.event.addListenerOnce(map, 'idle', function(){
					getViewportEvents(map.getBounds());
				});
				google.maps.event.addListener(map, 'dragend', function() {
					getViewportEvents(map.getBounds());
				});
				google.maps.event.addListener(map, 'zoom_changed', function() {
					getViewportEvents(map.getBounds());
				});
				google.maps.event.addListener(map, 'rightclick', function(event) {
					saveEvent(event.latLng);
				});
				
				eventsContainer = new Array();
			}
			
			function keyHandler(e) {
		    	if(e.keyCode == 13 && document.getElementById("destiny").value != "")
		    		routePlanner();
		    }
		    
		    function routePlanner() {
		    	destinyName = document.getElementById("destiny").value;
		    	generateRoute(destinyName);
		    }
		    
		    function generateRoute(destiny) {
		    	var destinyGeocoder = new google.maps.Geocoder();
		    	
		    	destinyGeocoder.geocode({'bounds': map.getBounds(), 'address': destiny}, function(destinyResults, destinyStatus) {
		    		if(destinyStatus == google.maps.GeocoderStatus.OK) {
		    			finalLatLng = new google.maps.LatLng(destinyResults[0].geometry.location.lat(), destinyResults[0].geometry.location.lng());
		    			processRoute(new google.maps.LatLng(userLat, userLng), finalLatLng);
		    		}
		    		else if(destinyStatus == google.maps.GeocoderStatus.ZERO_RESULTS)
		    			directionsDisplay.setMap(null);
		    	});
			}
		    
		    function processRoute(originLatLng, destinyLatLng) {
		    	directionsDisplay.setMap(map);
		    	
		    	var request = {
		    		origin: originLatLng,
		    		destination: destinyLatLng,
		    		travelMode: google.maps.TravelMode.DRIVING
		  		};
		    	
		    	var directionsService = new google.maps.DirectionsService();
		  		directionsService.route(request, function(result, status) {
		    		if (status == google.maps.DirectionsStatus.OK) {
		    			directionsDisplay.setDirections(result);
		    			determineIntersection(result.routes[0].overview_path);
		    		}
		  		});
		    }
		    
		    function determineIntersection(path) {
		    	web_determineIntersection(path);
		    }
		    
		    function getViewportEvents(bounds) {
		    	var events = web_getViewportEvents(bounds);
		    }
		    
		    function saveEvent(latLng) {
		    	web_saveEvent(latLng);
		    }
		    
		    function createMarker(lat, lng, text) {
		    	var marker = new google.maps.Marker({
		    	    position: new google.maps.LatLng(lat, lng)
		    	});
		    	
		    	google.maps.event.addListener(marker, 'click', function() {
		    		infowindow.setContent(text);
		    		infowindow.open(map, marker);
		    	});
		    	
		    	return marker;
		    }

		</script>
		
		<script type="text/javascript" src="web-functions.js"></script>
		<script type="text/javascript" src="apporta.js"></script>
		<script type="text/javascript" src="math-functions.js"></script>
		
	</head>
	<body onload="initialize()">
		<div>
			<input id="destiny" type="text" onkeypress="keyHandler(event)" />
			<input type="button" value="Go!" onclick="routePlanner()" />
		</div>
		<div id="map_canvas" style="width:100%; height:100%"></div>
	</body>
</html>