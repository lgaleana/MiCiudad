<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, user-scalable=no" />
		<meta charset="UTF-8" />
		<title>Apporta</title>
		
		<style type="text/css">
			html, body, #map_canvas { height: 100%; margin: 0; padding: 0; }
			#top_bar { position: absolute; left: 0; right: 0; z-index: 1000; background-color: white; }
			#search_text { position: absolute; left: 2em; right: 9em; }
			#destiny { width: 100%; }
			.float_left { float: left; }
			.float_right { float: right; }
		</style>
		
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyD-J2vNmhqJRrtq2snuPNW4xPpk8D6w4es&sensor=true&language=es&region=MX"></script>
		
		<script type="text/javascript">
			var initialZoom = 13;
			var map;
			
			var earthRadius = 6378137;
			
			var TRAFFIC = 0;
			var ACCIDENT = 1;
			var INFRAESTRUCTURE = 2;
			var POLICE = 3;
			var OTHER = 4;
			
			var infowindow;
			var directionsDisplay;
			
			var userMarker;
			var eventsContainer;
			
			var android = false;
		
			function initialize() {
				android = (navigator.userAgent.indexOf('Android') != -1);
				
				map = new google.maps.Map(document.getElementById("map_canvas"), {
					center: new google.maps.LatLng(getUserLat(), getUserLng()),
					zoom: initialZoom,
					mapTypeId: google.maps.MapTypeId.ROADMAP,
					panControl: false,
					zoomControl: true,
					mapTypeControl: false,
					streetViewControl: false,
					overviewMapControl: false
				});

				infowindow = new google.maps.InfoWindow();
				directionsDisplay = new google.maps.DirectionsRenderer();
				userMarker = createUserMarker(0.0, 0.0);
				
				eventsContainer = new Array();
				
				google.maps.event.addListenerOnce(map, 'idle', function() {
					setInterval(displayUserLocation, 1000);
				});
				google.maps.event.addListener(map, 'bounds_changed', function() {
					getViewportEvents(map.getBounds());
				});
			}
		    
		    function displayUserLocation() {
		    	var userLat = getUserLat();
		    	var userLng = getUserLng();
		    	
		    	if(userMarker.getPosition().lat() != userLat || userMarker.getPosition().lng() != userLng) {
		    		var marker = createUserMarker(userLat, userLng);
			    	marker.setMap(map);
			    	
			    	if(userMarker)
			    		userMarker.setMap(null);
			    	
			    	userMarker = marker;
		    	}
		    }
		    
		    function getUserLat() {
		    	var lat;
		    	if(android)
		    		lat = Android.getUserLat();
		    	else
		    		lat = web_getUserLat();
		    	
		    	return lat;
		    }
		    
		    function getUserLng() {
		    	var lng;
		    	if(android)
		    		lng = Android.getUserLng();
		    	else
		    		lng = web_getUserLng();
		    	
		    	return lng;
		    }
		    
		    function getViewportEvents(bounds) {
		    	web_getViewportEvents(bounds);
		    }
		    
		    function saveEvent() {
		    	if(android)
		    		Android.showDialog();
		    	
		    	setTimeout(function() {getViewportEvents(map.getBounds())}, 1000);
		    }

		</script>
		
		<script type="text/javascript" src="web-functions.js"></script>
		<script type="text/javascript" src="apporta.js"></script>
		<script type="text/javascript" src="directions.js"></script>
		<script type="text/javascript" src="math-functions.js"></script>
		
	</head>
	<body onload="initialize()">
		<div id="top_bar">
			<div class="float_right">
				<input type="button" onclick="saveEvent()" />
				<input type="button" onclick="" />
			</div>
			<div>
				<input class="float_left" type="button" />
				<input class="float_right" type="button" value="Buscar" onclick="routePlanner()" />
				<div id="search_text">
					<input id="destiny" type="text" placeholder="Buscar" onkeypress="keyHandler(event)" />
				</div>
			</div>
		</div>
		<div id="map_canvas"></div>
	</body>
</html>